{% extends "base.html" %}

{% block title %}编辑文章 - {{ post.title }} - 我的博客{% endblock %}

{% block head_extra %}
<style>
    /* 与 create_post.html 相同的 EasyMDE 样式 */
    .EasyMDEContainer {
        border-color: var(--bs-border-color);
    }
    .CodeMirror {
        background-color: var(--bs-body-bg);
        color: var(--bs-body-color);
        border-color: var(--bs-border-color);
    }
    .editor-toolbar {
        background-color: var(--bs-tertiary-bg);
        border-color: var(--bs-border-color);
    }
     .editor-toolbar a {
        color: var(--bs-body-color) !important;
    }
    .editor-preview, .editor-preview-side {
        background-color: var(--bs-body-bg);
    }
</style>
{% endblock %}


{% block content %}
<div id="main-content-wrapper" class="container mt-4 mb-5">
    <div class="card shadow-sm">
        <div class="card-body">
            <h2 class="card-title">编辑文章</h2>
            <hr>
            {# ... (Flash 消息) ... #}
            <form method="POST" action="{{ url_for('main.edit_post', slug=post.slug) }}" id="post-form">
                {# ... (表单字段保持不变) ... #}
                <div class="mb-3">
                    <label for="title" class="form-label">标题</label>
                    <input type="text" class="form-control" id="title" name="title"
                           value="{{ post.title }}" required>
                </div>
                <div class="mb-3">
                    <label for="category" class="form-label">分类 (可选)</label>
                    <input type="text" class="form-control" id="category" name="category"
                           value="{{ post.category.name if post.category else '' }}">
                </div>
                <div class="mb-3">
                    <label for="tags" class="form-label">标签 (用逗号分隔, 可选)</label>
                    <input type="text" class="form-control" id="tags" name="tags"
                           value="{{ existing_tags }}">
                </div>
                <div class="mb-3">
                    <label for="body" class="form-label">内容 (支持 Markdown)</label>
                    <textarea class="form-control" id="body" name="body" rows="15" >{{ post.body }}</textarea>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> 保存更改
                </button>
                <a href="{{ url_for('main.post', slug=post.slug) }}" class="btn btn-secondary ms-2 internal-link">
                     <i class="fas fa-times"></i> 取消
                </a>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof EasyMDE !== 'undefined') {
        var easyMDE = new EasyMDE({
            element: document.getElementById("body"),
            spellChecker: false,
            autosave: { enabled: true, uniqueId: "edit_post_{{ post.id }}", delay: 2000, },
            placeholder: "在这里继续写作...",
            status: ["autosave", "lines", "words", "cursor"],
            toolbar:  [ "bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "|", "link",
                { name: "image", action: function(editor) { selectAndUploadFile(editor, 'image'); }, className: "fa fa-image", title: "上传图片" },
                { name: "video", action: function(editor) { selectAndUploadFile(editor, 'video'); }, className: "fa fa-video", title: "上传视频" },
                "|", "preview", "side-by-side", "fullscreen", "|", "guide" ],
        });

        function selectAndUploadFile(editor, type) { var input = document.createElement('input');
            input.type = 'file';
            input.accept = type === 'image' ? 'image/png, image/jpeg, image/gif' : 'video/mp4, video/webm, video/ogg';
            input.onchange = e => {
                var file = e.target.files[0];
                if (file) { uploadFile(file, editor, type); }
            }
            input.click(); }

        // ************ 关键修改点: 使用新的 uploadFile ************
        function uploadFile(file, editor, type) {
            var formData = new FormData();
            formData.append('file', file);
            var cm = editor.codemirror;
            var doc = cm.getDoc();
            var cursor = doc.getCursor();
            var placeholderText = `\n[上传中: ${file.name}...]\n`;
            doc.replaceRange(placeholderText, cursor);

            fetch("{{ url_for('main.upload_file') }}", { method: 'POST', body: formData, })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || `HTTP ${response.status}`); });
                }
                return response.json();
            })
            .then(data => {
                let output = '';
                if (data.url) {
                    if (type === 'image') {
                        output = `![${file.name}](${data.url})\n`;
                    } else {
                        output = `\n<video width="100%" controls>\n  <source src="${data.url}" type="${file.type}">\n  您的浏览器不支持视频标签。\n</video>\n`;
                    }
                } else {
                    alert('上传失败: ' + (data.error || '未知错误'));
                    output = '';
                }
                var currentContent = doc.getValue();
                var placeholderIndex = currentContent.indexOf(placeholderText);
                if (placeholderIndex > -1) {
                    var startPos = doc.posFromIndex(placeholderIndex);
                    var endPos = doc.posFromIndex(placeholderIndex + placeholderText.length);
                    doc.replaceRange(output, startPos, endPos);
                } else {
                    console.warn("未找到占位符，将在原始光标处插入。");
                    doc.replaceRange(output, cursor);
                }
            })
            .catch(error => {
                alert('上传发生错误: ' + error.message);
                var currentContent = doc.getValue();
                var placeholderIndex = currentContent.indexOf(placeholderText);
                if (placeholderIndex > -1) {
                    var startPos = doc.posFromIndex(placeholderIndex);
                    var endPos = doc.posFromIndex(placeholderIndex + placeholderText.length);
                    doc.replaceRange('', startPos, endPos);
                }
                console.error('上传错误:', error);
            });
        }
        // *******************************************************
    } else {
        console.error("EasyMDE 未能加载!");
    }
});
</script>
{% endblock %}